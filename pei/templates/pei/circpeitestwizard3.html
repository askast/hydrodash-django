{% extends "profiles/stislabase.html" %}
{% load static %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.0/css/select.bootstrap4.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/1.0.7/css/responsive.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css">

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/select/1.3.0/js/dataTables.select.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/select/1.3.0/js/select.bootstrap4.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.19/dataRender/datetime.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/responsive/1.0.7/js/dataTables.responsive.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js" defer type="text/javascript"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js" defer type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js" defer type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js" defer type="text/javascript"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.colVis.min.js" defer type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.26/moment-timezone-with-data.min.js" defer
    type="text/javascript"></script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>

{% endblock %}

{% block content %}

<div class="main-content">
    <section class="section">
        <div class="section-header">
            <h1> Circulator PEI</h1>
            <div class="section-header-breadcrumb">
                <div class="breadcrumb-item active"><a href="#">Dashboard</a></div>
                <div class="breadcrumb-item"><a href="#">PEI Calculator</a></div>
            </div>
        </div>

        <div class="section-body">
            <h2 class="section-title">Circulator PEI Test Wizard</h2>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4>Use After Data Reduction</h4>
                        </div>
                        <div class="card-body">
                            <div class="row mt-4">
                                <div class="col-12 col-lg-8 offset-lg-2">
                                    <div class="wizard-steps">
                                        <div class="wizard-step">
                                            <div class="wizard-step-icon">
                                                <i class="fas fa-tachometer-alt"></i>
                                            </div>
                                            <div class="wizard-step-label">
                                                Select Max Speed Curve
                                            </div>
                                        </div>
                                        <div class="wizard-step">
                                            <div class="wizard-step-icon">
                                                <i class="fas fa-tasks"></i>
                                            </div>
                                            <div class="wizard-step-label">
                                                Reduced Speed Points to Test
                                            </div>
                                        </div>
                                        <div class="wizard-step wizard-step-active">
                                            <div class="wizard-step-icon">
                                                <i class="fas fa-database"></i>
                                            </div>
                                            <div class="wizard-step-label">
                                                Circulator PEI
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <form class="wizard-content mt-2">
                                <div class="wizard-pane">
                                    <div class="row mt-4">
                                        <div class="col-12 col-md-6 col-lg-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h4 id="test1id"></h4>
                                                </div>
                                                <div class="card-body">
                                                    <div id="chart1" class="chart">

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-6 col-lg-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h4>PEI Calculator result</h4>
                                                </div>
                                                <div class="card-body">
                                                    <table class="table table-hover responsive" id="table1">                                                 
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-4">
                                        <div class="col-12 col-md-6 col-lg-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h4>HI Upload Speadsheet Input</h4>
                                                </div>
                                                <div class="card-body" id="upload_text">
                                                </div>
                                                <div class="card-footer text-right">
                                                    <button class="btn btn-primary" id='upload_btn'>Copy</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6 col-lg-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h4>HI Calculator Speadsheet Input</h4>
                                                </div>
                                                <div class="card-body" id="calc_text">
                                                </div>
                                                <div class="card-footer text-right">
                                                    <button class="btn btn-primary" id='calc_btn'>Copy</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    var upload_copy_text = "";
    var calc_copy_text = "";
    function copyToClipboard(text) {
        var $temp = $("<input>");
        $("body").append($temp);
        $temp.val(text).select();
        document.execCommand("copy");
        $temp.remove();
    }
    $(document).ready(function () {
        $("#calc_btn").click(
            function(event) {
                event.preventDefault();
                copyToClipboard(calc_copy_text);
            }
        );
        $("#upload_btn").click(
            function(event) {
                event.preventDefault();
                copyToClipboard(upload_copy_text);
            }
        );
        var basechartoptions = {
            chart: {
                zoomType: 'xy'
            },
            title: {
                text: ''
            },
            xAxis: {
                minorTickInterval: 'auto',
                gridLineWidth: 1
            },
            yAxis: {
                minorTickInterval: 'auto',
                gridLineWidth: 1
            },
            legend: {
                enabled: false
            },
            plotOptions: {},
            series: [
                {
                    type: 'scatter',
                    marker: {
                        fillColor: '#000000',
                        radius: 3,
                        symbol: 'circle'
                    }
                },{
                    type: 'scatter',
                    marker: {
                        fillColor: '#AF7AC5',
                        radius: 8,
                        symbol: 'diamond'
                    }
                },{
                    type: 'scatter',
                    marker: {
                        fillColor: '#48C9B0',
                        radius: 3,
                        symbol: 'square'
                    }
                },{
                    type: 'scatter',
                    marker: {
                        fillColor: '#EC7063',
                        radius: 3,
                        symbol: 'circle'
                    }
                }
            ],
            exporting: {
                enabled: false
            }
        };

        const pageUpdate = () => {
            $.getJSON(
                "{% url 'circpeidata' %}", {
                    test1id: parseInt("{{ test1id }}"),
                    test2id: parseInt("{{ test2id }}"),
                }).done(function (data) {
                    $("#test1id").text(data.test1name);
                    var test1data = [];
                    for (var i = 0; i < data.test1flow.length; i++) {
                        test1data.push([data.test1flow[i], data.test1head[i]]);
                    }
                    var testpointsdata = [];
                    for (var i = 0; i < data.testpointsflow.length; i++) {
                        testpointsdata.push([data.testpointsflow[i], data.testpointshead[i]]);
                    }
                    var test2greendata = [];
                    for (var i = 0; i < data.test2flowgreen.length; i++) {
                        test2greendata.push([data.test2flowgreen[i], data.test2headgreen[i]]);
                    }
                    var test2reddata = [];
                    for (var i = 0; i < data.test2flowred.length; i++) {
                        test2reddata.push([data.test2flowred[i], data.test2headred[i]]);
                    }
                    $("#table1").append("<tr><th colspan='2'>Least Consumptive</th></tr><tr><th>PEI</th><td>"+data.peiresult["PEI"].toFixed(2)+"</td></tr><tr><th>ER</th><td>"+data.peiresult["ER"].toFixed(0)+"</td></tr><tr><th colspan='2'>Most Consumptive</th></tr><tr><th>PEI</th><td>"+data.peiresult["PEI_most_consumptive"].toFixed(2)+"</td></tr><tr><th>ER</th><td>"+data.peiresult["ER_most_consumptive"].toFixed(0)+"</td></tr>");

                    $("#upload_text").append(data.upload_csv_input);
                    $("#calc_text").append(data.calculator_csv_input);
                    upload_copy_text = data.upload_csv_input;
                    calc_copy_text = data.calculator_csv_input;
                    basechartoptions.series[0].data = test1data;
                    basechartoptions.series[1].data = testpointsdata;
                    basechartoptions.series[2].data = test2greendata;
                    basechartoptions.series[3].data = test2reddata;
                    basechartoptions.xAxis.title = {
                        text: "GPM"
                    };
                    basechartoptions.yAxis.title = {
                        text: "Feet"
                    };
                    Highcharts.chart('chart1', basechartoptions);
                }
            );
        };
        pageUpdate();
    });
</script>
{% endblock content%}